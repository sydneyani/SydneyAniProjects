WITH Manager_Hierarchy AS (
    SELECT 
        EMP_ID,
        MGR_LVL1_ID,
        MGR_LVL2_ID,
        MGR_LVL3_ID,
        MGR_LVL4_ID,
        MGR_LVL5_ID,
        ROW_NUMBER() OVER (PARTITION BY EMP_ID ORDER BY EFFECTIVE_END_DATE DESC) AS RN
    FROM 
        EMP_MANAGER_HIERARCHY
)
SELECT DISTINCT 
    EMP.PERSON_NUM,
    ASSIGN.ASSIGN_TYPE,
    EMP_NAME.FIRST_NAME || ' ' || EMP_NAME.LAST_NAME AS EMPLOYEE_NAME,
    MGR_LVL1_NAME.FIRST_NAME || ' ' || MGR_LVL1_NAME.LAST_NAME AS SUPERVISOR_NAME,
    MGR_LVL2_NAME.FIRST_NAME || ' ' || MGR_LVL2_NAME.LAST_NAME AS SECOND_LEVEL_SUPERVISOR_NAME,
    MGR_LVL3_NAME.FIRST_NAME || ' ' || MGR_LVL3_NAME.LAST_NAME AS THIRD_TIER_MANAGER,
    MGR_LVL4_NAME.FIRST_NAME || ' ' || MGR_LVL4_NAME.LAST_NAME AS SECOND_TIER_MANAGER,
    MGR_LVL5_NAME.FIRST_NAME || ' ' || MGR_LVL5_NAME.LAST_NAME AS FIRST_TIER_MANAGER
FROM 
    EMP_DETAILS EMP
    JOIN EMP_NAMES EMP_NAME ON EMP.EMP_ID = EMP_NAME.EMP_ID
    JOIN EMP_ASSIGNMENTS ASSIGN ON EMP.EMP_ID = ASSIGN.EMP_ID
    JOIN Manager_Hierarchy MH ON EMP.EMP_ID = MH.EMP_ID AND MH.RN = 1
    JOIN EMP_DETAILS MGR_LVL1 ON MH.MGR_LVL1_ID = MGR_LVL1.EMP_ID
    JOIN EMP_NAMES MGR_LVL1_NAME ON MGR_LVL1.EMP_ID = MGR_LVL1_NAME.EMP_ID
    JOIN EMP_DETAILS MGR_LVL2 ON MH.MGR_LVL2_ID = MGR_LVL2.EMP_ID
    JOIN EMP_NAMES MGR_LVL2_NAME ON MGR_LVL2.EMP_ID = MGR_LVL2_NAME.EMP_ID
    JOIN EMP_DETAILS MGR_LVL3 ON MH.MGR_LVL3_ID = MGR_LVL3.EMP_ID
    JOIN EMP_NAMES MGR_LVL3_NAME ON MGR_LVL3.EMP_ID = MGR_LVL3_NAME.EMP_ID
    JOIN EMP_DETAILS MGR_LVL4 ON MH.MGR_LVL4_ID = MGR_LVL4.EMP_ID
    JOIN EMP_NAMES MGR_LVL4_NAME ON MGR_LVL4.EMP_ID = MGR_LVL4_NAME.EMP_ID
    JOIN EMP_DETAILS MGR_LVL5 ON MH.MGR_LVL5_ID = MGR_LVL5.EMP_ID
    JOIN EMP_NAMES MGR_LVL5_NAME ON MGR_LVL5.EMP_ID = MGR_LVL5_NAME.EMP_ID
WHERE 
    TRUNC(SYSDATE) BETWEEN EMP.EFFECTIVE_START_DATE AND EMP.EFFECTIVE_END_DATE
    AND TRUNC(SYSDATE) BETWEEN EMP_NAME.EFFECTIVE_START_DATE AND EMP_NAME.EFFECTIVE_END_DATE
    AND EMP_NAME.NAME_TYPE = 'GLOBAL'
    AND TRUNC(SYSDATE) BETWEEN ASSIGN.EFFECTIVE_START_DATE AND ASSIGN.EFFECTIVE_END_DATE
    AND ASSIGN.ASSIGN_STATUS_TYPE IN ('ACTIVE')
    AND ASSIGN.ASSIGN_TYPE = 'E'
    AND ASSIGN.EFFECTIVE_LATEST_CHANGE = 'Y'
    AND TRUNC(SYSDATE) BETWEEN MGR_LVL1.EFFECTIVE_START_DATE AND MGR_LVL1.EFFECTIVE_END_DATE
    AND TRUNC(SYSDATE) BETWEEN MGR_LVL1_NAME.EFFECTIVE_START_DATE AND MGR_LVL1_NAME.EFFECTIVE_END_DATE
    AND MGR_LVL1_NAME.NAME_TYPE = 'GLOBAL'
    AND TRUNC(SYSDATE) BETWEEN MGR_LVL2.EFFECTIVE_START_DATE AND MGR_LVL2.EFFECTIVE_END_DATE
    AND TRUNC(SYSDATE) BETWEEN MGR_LVL2_NAME.EFFECTIVE_START_DATE AND MGR_LVL2_NAME.EFFECTIVE_END_DATE
    AND MGR_LVL2_NAME.NAME_TYPE = 'GLOBAL'
    AND TRUNC(SYSDATE) BETWEEN MGR_LVL3.EFFECTIVE_START_DATE AND MGR_LVL3.EFFECTIVE_END_DATE
    AND TRUNC(SYSDATE) BETWEEN MGR_LVL3_NAME.EFFECTIVE_START_DATE AND MGR_LVL3_NAME.EFFECTIVE_END_DATE
    AND MGR_LVL3_NAME.NAME_TYPE = 'GLOBAL'
    AND TRUNC(SYSDATE) BETWEEN MGR_LVL4.EFFECTIVE_START_DATE AND MGR_LVL4.EFFECTIVE_END_DATE
    AND TRUNC(SYSDATE) BETWEEN MGR_LVL4_NAME.EFFECTIVE_START_DATE AND MGR_LVL4_NAME.EFFECTIVE_END_DATE
    AND MGR_LVL4_NAME.NAME_TYPE = 'GLOBAL'
    AND TRUNC(SYSDATE) BETWEEN MGR_LVL5.EFFECTIVE_START_DATE AND MGR_LVL5.EFFECTIVE_END_DATE
    AND TRUNC(SYSDATE) BETWEEN MGR_LVL5_NAME.EFFECTIVE_START_DATE AND MGR_LVL5_NAME.EFFECTIVE_END_DATE
    AND MGR_LVL5_NAME.NAME_TYPE = 'GLOBAL'
ORDER BY 
    EMP.PERSON_NUM;
